## 유즈 케이스 분석
### 유저 대기열 진입 및 토큰 발급
| 항목 | 내용 |
| --- | --- |
| 행위자 | 일반 사용자 |
| 목표 | 대기열에 진입하여 토큰을 발급받는다 |
| 트리거 | `/queue/token` 요청 |
| 시스템 책임 | `Redis`에 사용자 추가 + 순번 계산 + 토큰 발급 |
| 예외 흐름 | 이미 대기 중인 유저 → 기존 토큰 반환 or 중복 등록 방지 |
| 상태 변화 | 없음 (토큰이 발급되며 시스템은 유저를 대기열로 인식) |

### 대기열 상태 확인
| 항목 | 내용 |
| --- | --- |
| 행위자 | 일반 사용자 |
| 목표 | 현재 나의 대기 순번과 예상 대기시간을 조회한다 |
| 트리거 | `/queue/status` 요청 (polling) |
| 시스템 책임 | `Redis`로 순번 계산 + 평균 처리 시간 기반 예상 시간 계산 |
| 예외 흐름 | 큐에 없는 사용자 → 오류 응답 |
| 상태 변화 | 없음 (단순 조회) |

### 예약 가능한 콘서트 조회
| 항목 | 내용 |
| --- | --- |
| 행위자 | 일반 사용자 |
| 목표 | 예약 가능한 콘서트 목록을 확인한다 |
| 트리거 | `/events/available` 요청 |
| 시스템 책임 | 오늘 이후 예약 가능한 이벤트 목록 반환 |
| 예외 흐름 | 예약 가능한 콘서트 없음 |
| 상태 변화 | 없음 |

### 예약 가능 날짜 조회
| 항목 | 내용 |
| --- | --- |
| 행위자 | 일반 사용자 |
| 목표 | 선택한 콘서트에 대해 예약 가능한 날짜를 조회한다 |
| 트리거 | `/events/{id}/dates` 요청 |
| 시스템 책임 | 콘서트 날짜 중 예약 가능한 날짜 리스트 반환 |
| 예외 흐름 | 콘서트가 존재하지 않음 |
| 상태 변화 | 없음 |

### 특정 날짜 좌석 조회
| 항목 | 내용 |
| --- | --- |
| 행위자 | 일반 사용자 |
| 목표 | 선택한 날짜의 좌석 상태를 조회한다 |
| 트리거 | `/events/{id}/seats?date=...` 요청 |
| 시스템 책임 | 좌석별 예약 상태(FREE, TEMP, CONFIRMED) 반환 |
| 예외 흐름 | 잘못된 날짜 요청 |
| 상태 변화 | 없음 |

### 좌석 예약 요청
| 항목 | 내용 |
| --- | --- |
| 행위자 | 대기열 앞 순번 사용자 |
| 목표 | 특정 좌석(들)을 임시로 예약한다 |
| 트리거 | `/reservations` 요청 |
| 시스템 책임 | `reservation`, `reservation_seats` 생성 + 상태 `TEMP` 설정 + `expires_at` 계산 |
| 예외 흐름 | 대기열 순번이 아니거나 좌석 중복 점유 시 → 에러 |
| 상태 변화 | 좌석 상태: FREE → TEMP, 예약 상태: CREATED (TEMP) (※ Reservation 상태에 따라 간접 유도됨)|

### 잔액 충전
| 항목 | 내용 |
| --- | --- |
| 행위자 | 일반 사용자 |
| 목표 | 자신의 계정에 잔액을 충전한다 |
| 트리거 | `/wallets/charge` 요청 |
| 시스템 책임 | 유저 잔액 갱신 (증가) |
| 예외 흐름 | 금액 음수, 유효하지 않은 사용자 |
| 상태 변화 | `users.balance` 증가 |

### 잔액 조회
| 항목 | 내용 |
| --- | --- |
| 행위자 | 일반 사용자 |
| 목표 | 현재 내 잔액을 조회한다 |
| 트리거 | `/wallets/me` 요청 |
| 시스템 책임 | `users.balance` 반환 |
| 예외 흐름 | 없음 |
| 상태 변화 | 없음 |

### 좌석 결제
| 항목 | 내용 |
| --- | --- |
| 행위자 | 일반 사용자 |
| 목표 | 임시 예약된 좌석에 대해 결제를 완료한다 |
| 트리거 | `/payments` 요청 |
| 시스템 책임 | 결제 내역 생성, 예약 상태 `CONFIRMED` 변경, 잔액 차감 |
| 예외 흐름 | 잔액 부족, 만료된 예약, 좌석이 이미 확정됨 |
| 상태 변화 | `reservation.status = CONFIRMED`, `users.balance -= amount` |

### 좌석 예약 만료 처리 (비동기)
| 항목 | 내용 |
| --- | --- |
| 행위자 | 시스템 |
| 목표 | 결제 없이 만료된 예약을 자동으로 취소한다 |
| 트리거 | `@Scheduled` or Redis TTL 이벤트 |
| 시스템 책임 | `expires_at < now()` 이면서 `TEMP`인 예약을 `CANCELED`로 변경 |
| 예외 흐름 | 없음 |
| 상태 변화 | `reservation.status = CANCELED` |

### 예약 내역 조회
| 항목 | 내용 |
| --- | --- |
| 행위자 | 일반 사용자 |
| 목표 | 본인이 예약한 좌석 내역을 확인한다 |
| 트리거 | `/reservations/me` 요청 |
| 시스템 책임 | 유저의 예약 정보 필터링해서 반환 |
| 예외 흐름 | 예약 내역 없음 |
| 상태 변화 | 없음 |

### 예약 취소
| 항목 | 내용 |
| --- | --- |
| 행위자 | 일반 사용자 |
| 목표 | 본인이 예약한 TEMP 또는 CONFIRMED 좌석을 취소한다 |
| 트리거 | `/reservations/{id}/cancel` 요청 |
| 시스템 책임 | 예약 상태 `CANCELED`로 변경, 좌석 점유 해제 |
| 예외 흐름 | 이미 만료되었거나 CONFIRMED 상태에서 취소 불가 시도 |
| 상태 변화 | `reservation.status = CANCELED` |
